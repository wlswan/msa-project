<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket ì•Œë¦¼ ìë™ ì—°ê²°</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
        #log { background: #fff; border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: scroll; }
        input, button { margin: 5px; padding: 8px; }
    </style>
</head>
<body>

<h2>ğŸ’¬ ë¡œê·¸ì¸ â†’ ìë™ WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸</h2>

<div>
    <label>ì•„ì´ë””:</label>
    <input type="text" id="username" value="testuser1">
    <label>ë¹„ë°€ë²ˆí˜¸:</label>
    <input type="password" id="password" value="12345678">
    <button onclick="login()">ë¡œê·¸ì¸ í›„ ìë™ ì—°ê²°</button>
</div>

<h3>ğŸ“œ ë¡œê·¸</h3>
<pre id="log"></pre>

<script>
    let stompClient = null;
    let token = null;

    function log(msg) {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        console.log(msg);
    }

    // ë¡œê·¸ì¸ ì‹œë„ â†’ JWT ë°œê¸‰ â†’ ë°”ë¡œ WebSocket ì—°ê²°
    async function login() {
        log("ğŸ” ë¡œê·¸ì¸ ì‹œë„ ì¤‘...");

        try {
            const res = await fetch("http://localhost:8080/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    username: document.getElementById("username").value,
                    password: document.getElementById("password").value
                })
            });

            const text = await res.text();
            log("ğŸ“¨ ë¡œê·¸ì¸ ì‘ë‹µ: " + text);

            const data = JSON.parse(text);
            token = data.token || data.accessToken || data.jwt;

            if (!token) {
                const header = res.headers.get("Authorization");
                if (header && header.startsWith("Bearer ")) {
                    token = header.substring(7);
                }
            }

            if (token) {
                log("âœ… ë¡œê·¸ì¸ ì„±ê³µ! JWT: " + token);
                connectWebSocket(token); // ğŸ”¥ ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¦‰ì‹œ WS ì—°ê²°
            } else {
                log("âŒ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

        } catch (e) {
            log("âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e);
        }
    }

    // WebSocket ì—°ê²°
    function connectWebSocket(token) {
        log("ğŸŒ WebSocket ì—°ê²° ì‹œë„ ì¤‘...");

        // ê²Œì´íŠ¸ì›¨ì´ í•„í„°ê°€ ?token= ì„ ì¸ì‹í•˜ê²Œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë ‡ê²Œ ì „ë‹¬
        const socket = new SockJS("http://localhost:8080/ws?token=" + token);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            log("âœ… WebSocket ì—°ê²° ì„±ê³µ: " + frame);

            // /user/queue/notifications êµ¬ë…
            stompClient.subscribe("/user/queue/notifications", function (msg) {
                const notification = JSON.parse(msg.body);
                log("ğŸ“¢ ìƒˆ ì•Œë¦¼: " + JSON.stringify(notification));
            });

        }, function (error) {
            log("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: " + error);
        });
    }
</script>
</body>
</html>
